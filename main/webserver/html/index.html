<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xiaomi Light bar for ESP Control</title>
    <link rel="stylesheet" href="css/milligram.min.css" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <header>
      <h1>Xiaomi Light bar for ESP Control</h1>
      <div id="api-key-controls" class="api-key-widget">
        <label for="api-key-input">X-API-Key</label>
        <input
          type="password"
          id="api-key-input"
          class="input-sm"
          placeholder="API key"
        />
        <button id="api-key-save" class="btn-sm">Save</button>
        <button id="api-key-clear" class="button-outline btn-sm">Clear</button>
        <span id="api-key-status"></span>
        <button
          id="api-key-close"
          class="btn-sm icon-btn"
          title="Hide"
          aria-label="Hide API Key"
        >
          Ã—
        </button>
      </div>
      <button
        id="api-key-toggle"
        class="api-key-toggle"
        title="Show API Key"
        aria-label="Show API Key"
      >
        ðŸ”‘
      </button>
      <button
        id="logs-toggle"
        class="logs-toggle"
        title="Show Logs"
        aria-label="Show Logs"
      >
        ðŸ“‹
      </button>
    </header>

    <div id="logs-modal" class="logs-modal hidden">
      <div class="logs-modal-overlay"></div>
      <div class="logs-modal-content">
        <div class="logs-modal-header">
          <h2>ESP32 Logs</h2>
          <button
            id="logs-close"
            class="logs-close-btn"
            title="Close"
            aria-label="Close Logs"
          >
            Ã—
          </button>
        </div>
        <div class="logs-modal-body">
          <button id="logs-fetch-btn" class="logs-fetch-btn">Fetch Logs</button>
          <div id="logs-loader" class="logs-loader"></div>
          <div id="logs-output" class="logs-output"></div>
        </div>
      </div>
    </div>

    <main>
      <div class="dashboard">
        <section id="status-section" class="container">
          <h2>System Status</h2>
          <button id="api-status-btn">Refresh Status</button>
          <div id="status-loader" class="loader"></div>
          <div id="status-output" class="output-container"></div>
        </section>

        <section id="wifi-section" class="container">
          <h2>Wi-Fi Management</h2>
          <button id="wifi-scan-btn">Scan Wi-Fi</button>
          <div id="wifi-loader" class="loader"></div>
          <div id="wifi-output" class="output-container"></div>
        </section>

        <section id="ntp-section" class="container">
          <h2>NTP Provider</h2>
          <label for="ntp-input">NTP Server:</label>
          <input type="text" id="ntp-input" placeholder="ex: pool.ntp.org" />
          <button id="ntp-set-btn">Set NTP Server</button>
          <div id="ntp-loader" class="loader"></div>
          <div id="ntp-output" class="output-container"></div>
        </section>

        <section id="nrf24-section" class="container">
          <h2>Xiaomi Remote ID Detection</h2>
          <p>
            Hold all buttons on your Xiaomi remote during the scan to capture
            all 6 command patterns:
          </p>
          <ul>
            <li>Press the knob (On/Off)</li>
            <li>Press + Turn knob cooler and warmer (color temperature)</li>
            <li>Turn knob higher and lower (brightness)</li>
            <li>Long-press knob (auto desktop mode)</li>
          </ul>
          <label for="nrf24-duration-input">Scan Duration (seconds):</label>
          <input
            type="number"
            id="nrf24-duration-input"
            value="10"
            min="1"
            max="60"
          />
          <button id="nrf24-scan-btn">Start NRF24 Scan</button>
          <div id="nrf24-loader" class="loader"></div>
          <div id="nrf24-output" class="output-container"></div>
        </section>
      </div>
    </main>

    <footer>
      <p>&copy; <span id="current-year"></span> Xiaomi Light bar for ESP</p>
    </footer>
    <script>
      (function () {
        const KEY_STORAGE = "x_api_key";
        const getKey = () => localStorage.getItem(KEY_STORAGE) || "";
        const setKey = (k) => localStorage.setItem(KEY_STORAGE, k || "");
        const clearKey = () => localStorage.removeItem(KEY_STORAGE);

        const origFetch = window.fetch.bind(window);
        window.fetch = function (input, init) {
          const key = getKey();
          if (key) {
            init = init || {};
            let headers = init.headers || {};

            if (headers instanceof Headers) {
              headers = new Headers(headers);
              headers.set("X-API-Key", key);
              init.headers = headers;
            } else if (Array.isArray(headers)) {
              init.headers = headers.concat([["X-API-Key", key]]);
            } else if (typeof headers === "object") {
              init.headers = Object.assign({}, headers, { "X-API-Key": key });
            } else {
              init.headers = { "X-API-Key": key };
            }
          }
          return origFetch(input, init);
        };

        document.addEventListener("DOMContentLoaded", function () {
          const input = document.getElementById("api-key-input");
          const saveBtn = document.getElementById("api-key-save");
          const clearBtn = document.getElementById("api-key-clear");
          const status = document.getElementById("api-key-status");
          const widget = document.getElementById("api-key-controls");
          const closeBtn = document.getElementById("api-key-close");
          const toggleBtn = document.getElementById("api-key-toggle");
          const COLLAPSE_STORAGE = "api_key_widget_hidden";

          const refreshStatus = () => {
            const has = !!getKey();
            status.textContent = has ? "Key set" : "No key";
            status.style.color = has ? "#4CAF50" : "var(--error-color)";
          };

          input.value = getKey();
          refreshStatus();

          saveBtn.addEventListener("click", function () {
            setKey(input.value.trim());
            refreshStatus();
          });

          clearBtn.addEventListener("click", function () {
            clearKey();
            input.value = "";
            refreshStatus();
          });

          const setHidden = (hidden) => {
            if (hidden) {
              widget.classList.add("hidden");
              toggleBtn.style.display = "inline-flex";
            } else {
              widget.classList.remove("hidden");
              toggleBtn.style.display = "none";
            }
          };

          let stored = localStorage.getItem(COLLAPSE_STORAGE);
          let hidden = stored === "1" || stored === null;
          setHidden(hidden);

          closeBtn.addEventListener("click", function () {
            setHidden(true);
            localStorage.setItem(COLLAPSE_STORAGE, "1");
          });
          toggleBtn.addEventListener("click", function () {
            setHidden(false);
            localStorage.setItem(COLLAPSE_STORAGE, "0");
          });
        });
      })();

      // Logs Modal Handler
      (function () {
        const LOGS_STORAGE = "logs_modal_hidden";
        const modal = document.getElementById("logs-modal");
        const toggleBtn = document.getElementById("logs-toggle");
        const closeBtn = document.getElementById("logs-close");
        const fetchBtn = document.getElementById("logs-fetch-btn");
        const logsOutput = document.getElementById("logs-output");
        const logsLoader = document.getElementById("logs-loader");

        const setModalHidden = (hidden) => {
          if (hidden) {
            modal.classList.add("hidden");
          } else {
            modal.classList.remove("hidden");
          }
        };

        let stored = localStorage.getItem(LOGS_STORAGE);
        let hidden = stored === "1" || stored === null;
        setModalHidden(hidden);

        toggleBtn.addEventListener("click", function () {
          setModalHidden(false);
          localStorage.setItem(LOGS_STORAGE, "0");
        });

        closeBtn.addEventListener("click", function () {
          setModalHidden(true);
          localStorage.setItem(LOGS_STORAGE, "1");
        });

        modal.addEventListener("click", function (event) {
          if (event.target.classList.contains("logs-modal-overlay")) {
            setModalHidden(true);
            localStorage.setItem(LOGS_STORAGE, "1");
          }
        });

        fetchBtn.addEventListener("click", function () {
          logsLoader.style.display = "block";
          logsOutput.textContent = "Fetching logs...";

          fetch("/api/v1/logs")
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              logsLoader.style.display = "none";

              if (Array.isArray(data)) {
                logsOutput.textContent = data.join("\n");
              } else if (typeof data === "object" && data.logs) {
                logsOutput.textContent = data.logs.join("\n");
              } else if (typeof data === "string") {
                logsOutput.textContent = data;
              } else {
                logsOutput.textContent = JSON.stringify(data, null, 2);
              }
            })
            .catch((error) => {
              logsLoader.style.display = "none";
              logsOutput.textContent = `Error fetching logs: ${error.message}`;
              logsOutput.style.color = "var(--error-color)";
            });
        });
      })();
    </script>
    <script src="js/main.js"></script>
  </body>
</html>
